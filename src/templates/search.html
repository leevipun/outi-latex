{% extends "base.html" %}

{% block title %}Outi LaTeX - Viiteenhallinta{% endblock %}
{% block body_class %}search-page{% endblock %}

{% block content %}
    <div>
        <h1 id="page-title">Outi LaTeX</h1>
        <p class="subtitle" id="page-subtitle">Hallitse viitteesi helposti</p>

        <form method="POST" action="/search" class="form-group" id="search-form">
            <label for="search-query" id="search-label">Etsi viitteitä</label>
            <div class="search-input-group">
                <input id="search-query" name="search-query" type="text" placeholder="Kirjoita hakusana..." value="{% if query %}{{query}}{% endif %}"/>
                <button type="submit" id="search-button">Hae viitteitä</button>
            </div>

            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filter-type">Viitetyyppi:</label>
                    <select id="filter-type" name="filter-type">
                        <option value="">Kaikki tyypit</option>
                        {% if reference_types %}
                            {% for ref_type in reference_types %}
                            <option value="{{ ref_type.name }}" {% if filter_type == ref_type.name %}selected{% endif %}>
                                {{ ref_type.name|capitalize }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="tag-filter">Avainsana:</label>
                    <select id="tag-filter" name="tag-filter">
                        <option value="">Kaikki avainsanat</option>
                        {% if tags %}
                            {% for tag in tags %}
                            <option value="{{ tag.name }}" {% if tag_filter == tag.name %}selected{% endif %}>{{ tag.name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sort-by">Järjestys:</label>
                    <select id="sort-by" name="sort-by">
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Uusin ensin</option>
                        <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>Vanhin ensin</option>
                        <option value="bib_key" {% if sort_by == 'bib_key' %}selected{% endif %}>Viiteavain (A-Ö)</option>
                        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Otsikko (A-Ö)</option>
                        <option value="author" {% if sort_by == 'author' %}selected{% endif %}>Tekijä (A-Ö)</option>
                    </select>
                </div>
            </div>
        </form>

        {% if data %}
        <h2 id="search-results-heading">Hakutulokset:</h2>
            {% for reference in data %}
            <div class="reference-item" id="reference-item-{{ reference['bib_key'] }}">
                <h3 id="reference-key-{{ reference['bib_key'] }}">{{ reference["bib_key"] }}</h3>
                <div class="reference-meta" id="reference-meta-{{ reference['bib_key'] }}">
                    <span class="meta-item" id="reference-type-{{ reference['bib_key'] }}">
                        <strong>Tyyppi:</strong> {{ reference["reference_type"]|capitalize }}
                    </span>
                    <span class="meta-item" id="reference-date-{{ reference['bib_key'] }}">
                        <strong>Luotu:</strong> {{ reference["created_at"] }}
                    </span>
                    {% if reference.get("username") %}
                        <span class="meta-item" id="reference-author-{{ reference['bib_key'] }}">
                            <strong>Luonut:</strong> {{ reference["username"] }}
                        </span>
                    {% endif %}
                </div>
                <ul class="fields-list" id="reference-fields-{{ reference['bib_key'] }}">
                    {% for key, value in reference["fields"].items() %}
                    <li id="field-{{ reference['bib_key'] }}-{{ key }}"><strong>{{ key }}:</strong> <span
                            id="value-{{ reference['bib_key'] }}-{{ key }}">{{ value }}</span></li>
                    {% endfor %}
                    {% if reference.get("tag") %}
                    <li id="reference-tag-{{ reference['bib_key'] }}"><strong>Tag:</strong> <span id="value-{{ reference['bib_key'] }}-tag">{{ reference["tag"]["name"] }}</span></li>
                    {% endif %}
                </ul>
                {% if session.get("user_id") %}
                <div style="display: flex; justify-content: space-between;">
                    {% if reference['bib_key'] in session["group"]["references"] %}
                    <form method="POST" action="/remove-group/{{ reference['bib_key'] }}" style="display:inline;">
                        <button id="remove-group-{{ reference['bib_key'] }}" type="submit">Poista ryhmästä</button>
                    </form>
                    {% else %}
                    <form method="POST" action="/add-group/{{ reference['bib_key'] }}" style="display:inline;">
                        <button id="add-group-{{ reference['bib_key'] }}" type="submit">Lisää ryhmään</button>
                    </form>
                    {% endif %}
                
                    {% if session["user_id"] == reference["owner_id"] %}
                    <div style="display: flex; gap: 10px;">
                        <form method="get" action="/edit/{{ reference['bib_key'] }}">
                            <button id="edit-button-{{ reference['bib_key'] }}" type="submit">Muokkaa</button>
                        </form>
                        <form method="post" action="{{ url_for('delete_reference', bib_key=reference['bib_key']) }}"
                            onsubmit="return confirm('Haluatko varmasti poistaa tämän viitteen?');">
                            <input type="hidden" name="bib_key" value="{{ reference['bib_key'] }}">
                            <button type="submit" id="delete-button-{{reference['bib_key']}}">Poista</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="no-results" id="no-results-div">
                <p id="no-results-message">Ei hakutuloksia.</p>
            </div>
        {% endif %}
    </div>
    <a href="/" class="btn" id="back-to-home-button">Takaisin etusivulle</a>
{% endblock %}
