{% extends "base.html" %}

{% block title %}K√§ytt√§j√§ - Outi LaTeX{% endblock %}
{% block body_class %}user-page{% endblock %}

{% block content %}
{% if user %}
    <div id="user-page-container">
        <!-- Viitteet osio (ensimm√§isen√§) -->
        <div class="user-references-section">
            <h1>üìö Viitteesi</h1>
            <hr/>

            {% if references %}
                <p class="references-count" style="margin-top: 10px;">Yhteens√§ <strong>{{ references|length }}</strong> viitett√§</p>

                <a href="{{ url_for('export_user_bibtex') }}"
                   id="export-bibtex-button"
                   class="button button-primary"
                   download="my_references.bib"
                   style="margin-left: 10px; background: #28a745; padding: 15px; border-radius: 10px; text-decoration: none;">
                    üìÑ Lataa BibTeX (.bib)
                </a>

                <div class="references-list">
                    {% for reference in references %}
                        <div class="reference-item" id="reference-item-{{ reference['bib_key'] }}">
                            <h3 id="reference-key-{{ reference['bib_key'] }}">{{ reference["bib_key"] }}</h3>
                            <div class="reference-meta" id="reference-meta-{{ reference['bib_key'] }}">
                                <span class="meta-item" id="reference-type-{{ reference['bib_key'] }}">
                                    <strong>Tyyppi:</strong> {{ reference["reference_type"]|capitalize }}
                                </span>
                                <span class="meta-item" id="reference-date-{{ reference['bib_key'] }}">
                                    <strong>Luotu:</strong> {{ reference["created_at"] }}
                                </span>
                                {% if reference.get("username") %}
                                    <span class="meta-item" id="reference-author-{{ reference['bib_key'] }}">
                                        <strong>Luonut:</strong> {{ reference["username"] }}
                                    </span>
                                {% endif %}
                            </div>
                            <ul class="fields-list" id="reference-fields-{{ reference['bib_key'] }}">
                                {% for key, value in reference["fields"].items() %}
                                <li id="field-{{ reference['bib_key'] }}-{{ key }}"><strong>{{ key }}:</strong> <span
                                        id="value-{{ reference['bib_key'] }}-{{ key }}">{{ value }}</span></li>
                                {% endfor %}
                                {% if reference["tag"] %}
                                <li id="reference-tag-{{ reference['bib_key'] }}"><strong>Tag:</strong> <span
                                        id="value-{{ reference['bib_key'] }}-tag">{{ reference["tag"]["name"] }}</span></li>
                                {% endif %}
                            </ul>
                            {% if session.get("user_id") %}
                            <div style="display: flex; justify-content: space-between;">
                                {% if reference['bib_key'] in session["group"]["references"] %}
                                <form method="POST" action="/remove-group/{{ reference['bib_key'] }}" style="display:inline;">
                                    <button id="remove-group-{{ reference['bib_key'] }}" type="submit">Poista ryhm√§st√§</button>
                                </form>
                                {% else %}
                                <form method="POST" action="/add-group/{{ reference['bib_key'] }}" style="display:inline;">
                                    <button id="add-group-{{ reference['bib_key'] }}" type="submit">Lis√§√§ ryhm√§√§n</button>
                                </form>
                                {% endif %}

                                {% if session["user_id"] == reference["owner_id"] %}
                                <div style="display: flex; gap: 10px;">
                                    <form method="get" action="/edit/{{ reference['bib_key'] }}">
                                        <button id="edit-button-{{ reference['bib_key'] }}" type="submit">Muokkaa</button>
                                    </form>
                                    <form method="post" action="{{ url_for('delete_reference', bib_key=reference['bib_key']) }}"
                                        onsubmit="return confirm('Haluatko varmasti poistaa t√§m√§n viitteen?');">
                                        <input type="hidden" name="bib_key" value="{{ reference['bib_key'] }}">
                                        <button type="submit" id="delete-button-{{reference['bib_key']}}">Poista</button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-references">
                    <p>üì≠ Et ole viel√§ lis√§nnyt yht√§√§n viitett√§.</p>
                    <a href="/" class="btn btn-primary">‚ûï Lis√§√§ ensimm√§inen viite</a>
                </div>
            {% endif %}
        </div>

        <hr style="margin: 40px 0; border: none; height: 2px; background: linear-gradient(90deg, transparent, var(--border-light), transparent);"/>

        <!-- Asetukset osio -->
        <div id="user-settings-container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="user-settings-title">‚öôÔ∏è K√§ytt√§j√§asetukset</h1>
                {% if theme == 'dark' %}
                <a href="{{ url_for('toggle_theme') }}" class="theme-toggle" id="theme-toggle" data-testid="theme-toggle"
                    aria-label="Vaihda vaaleaan tilaan">
                    <span>‚òÄÔ∏è Vaalea tila</span>
                </a>
                {% else %}
                <a href="{{ url_for('toggle_theme') }}" class="theme-toggle" id="theme-toggle" data-testid="theme-toggle"
                    aria-label="Vaihda tummaan tilaan">
                    <span>üåô Tumma tila</span>
                </a>
                {% endif %}
            </div>
            <hr style="margin-bottom: 10px;"/>

            <!-- Email Change Form -->
            <div class="settings-section">
                <h2 id="email-section-title">üìß Vaihda k√§ytt√§j√§nimi</h2>
                <form action="/update_username" method="post" id="username-form">
                    <div class="form-group">
                        <label for="current_username" id="current-username-label">
                            Nykyinen k√§ytt√§j√§nimi
                        </label>
                        <div style="padding: 12px 16px; background: var(--bg-light); border-radius: 10px; border: 2px solid var(--border-light); color: var(--text-dark); font-weight: 500;">
                            {{ user.username }}
                        </div>
                        <small class="helper-text">T√§m√§ on nykyinen k√§ytt√§j√§nimesi</small>
                    </div>

                    <div class="form-group">
                        <label for="new_username" id="new-username-label">
                            Uusi k√§ytt√§j√§nimi <span class="required">*</span>
                        </label>
                        <input type="text"
                               id="new_username"
                               name="new_username"
                               placeholder="uusi_kayttajanimi"
                               required>
                        <small class="helper-text">Sy√∂t√§ uusi k√§ytt√§j√§nimesi</small>
                    </div>

                    <div class="form-group">
                        <label for="confirm_username" id="confirm-username-label">
                            Vahvista uusi k√§ytt√§j√§nimi <span class="required">*</span>
                        </label>
                        <input type="text"
                               id="confirm_username"
                               name="confirm_username"
                               placeholder="uusi_kayttajanimi"
                               required>
                        <small class="helper-text">Sy√∂t√§ uusi k√§ytt√§j√§nimesi uudelleen</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="button-primary" id="update-username-button">
                            ‚úì P√§ivit√§ k√§ytt√§j√§nimi
                        </button>
                    </div>
                </form>
            </div>

            <!-- Password Change Form -->
            <div class="settings-section">
                <h2 id="password-section-title">üîê Vaihda salasana</h2>
                <form action="/update_password" method="post" id="password-form">
                    <div class="form-group">
                        <label for="current_password" id="current-password-label">
                            Nykyinen salasana <span class="required">*</span>
                        </label>
                        <input type="password"
                               id="current_password"
                               name="current_password"
                               required>
                        <small class="helper-text">Sy√∂t√§ nykyinen salasanasi vahvistusta varten</small>
                    </div>

                    <div class="form-group">
                        <label for="new_password" id="new-password-label">
                            Uusi salasana <span class="required">*</span>
                        </label>
                        <input type="password"
                               id="new_password"
                               name="new_password"
                               required
                               minlength="8">
                        <small class="helper-text">Salasanan tulee olla v√§hint√§√§n 8 merkki√§ pitk√§</small>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password" id="confirm-password-label">
                            Vahvista uusi salasana <span class="required">*</span>
                        </label>
                        <input type="password"
                               id="confirm_password"
                               name="confirm_password"
                               required
                               minlength="8">
                        <small class="helper-text">Sy√∂t√§ uusi salasana uudelleen</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="button-primary" id="update-password-button">
                            ‚úì P√§ivit√§ salasana
                        </button>
                    </div>
                </form>
            </div>

            <!-- Back to Home Link -->
            <div class="navigation-links">
                <a href="/" id="back-to-home" class="btn">‚Üê Takaisin etusivulle</a>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}