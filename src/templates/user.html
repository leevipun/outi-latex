{% extends "base.html" %}

{% block title %}K√§ytt√§j√§ - Outi LaTeX{% endblock %}
{% block body_class %}user-page{% endblock %}

{% block content %}
{% if user %}
    <div id="user-page-container">
        <!-- Viitteet osio (ensimm√§isen√§) -->
        <div class="user-references-section">
            <h1>üìö Omat viitteeni</h1>
            <hr/>

            {% if references %}
                <p class="references-count">Yhteens√§ <strong>{{ references|length }}</strong> viitett√§</p>

                <div class="references-list">
                    {% for reference in references %}
                    <div class="reference-item" id="reference-item-{{ reference['bib_key'] }}">
                        <div class="reference-header">
                            <h3>{{ reference['bib_key'] }}</h3>

                            <!-- N√§kyvyystila -->
                            {% if reference.get('is_public') == False %}
                            <span class="visibility-badge private">üîí Yksityinen</span>
                            {% else %}
                            <span class="visibility-badge public">üì¢ Julkinen</span>
                            {% endif %}
                        </div>

                        <div class="reference-metadata">
                            <p><strong>Tyyppi:</strong> <span class="type-badge">{{ reference['reference_type'] }}</span></p>
                            <p><strong>Luotu:</strong> {{ reference['created_at'] }}</p>
                        </div>

                        <!-- Kent√§t -->
                        {% if reference['fields'] %}
                        <div class="reference-fields">
                            <p style="margin-bottom: 12px; font-weight: 600; color: var(--primary-color); font-size: 13px; text-transform: uppercase;">Tiedot</p>
                            {% for key, value in reference['fields'].items() %}
                            <p><strong>{{ key }}:</strong> {{ value }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Tagi -->
                        {% if reference.get('tag') %}
                        <p class="reference-tag">
                            <span class="tag-badge">üè∑Ô∏è {{ reference['tag']['name'] }}</span>
                        </p>
                        {% endif %}

                        <!-- Toiminnot -->
                        <div class="reference-actions">
                            <a href="/edit/{{ reference['bib_key'] }}" class="btn btn-edit">‚úèÔ∏è Muokkaa</a>
                            <form action="/delete/{{ reference['bib_key'] }}" method="POST" style="display:inline; flex: 1;">
                                <button type="submit" class="btn btn-delete" style="width: 100%;"
                                        onclick="return confirm('Haluatko varmasti poistaa viitteen?')">
                                    üóëÔ∏è Poista
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-references">
                    <p>üì≠ Et ole viel√§ lis√§nnyt yht√§√§n viitett√§.</p>
                    <a href="/" class="btn btn-primary">‚ûï Lis√§√§ ensimm√§inen viite</a>
                </div>
            {% endif %}
        </div>

        <hr style="margin: 40px 0; border: none; height: 2px; background: linear-gradient(90deg, transparent, var(--border-light), transparent);"/>

        <!-- Asetukset osio -->
        <div id="user-settings-container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="user-settings-title">‚öôÔ∏è K√§ytt√§j√§asetukset</h1>
                {% if theme == 'dark' %}
                <a href="{{ url_for('toggle_theme') }}" class="theme-toggle" id="theme-toggle" data-testid="theme-toggle"
                    aria-label="Vaihda vaaleaan tilaan">
                    <span>‚òÄÔ∏è Vaalea tila</span>
                </a>
                {% else %}
                <a href="{{ url_for('toggle_theme') }}" class="theme-toggle" id="theme-toggle" data-testid="theme-toggle"
                    aria-label="Vaihda tummaan tilaan">
                    <span>üåô Tumma tila</span>
                </a>
                {% endif %}
            </div>
            <hr/>

            <!-- Email Change Form -->
            <div class="settings-section">
                <h2 id="email-section-title">üìß Vaihda k√§ytt√§j√§nimi</h2>
                <form action="/update_username" method="post" id="username-form">
                    <div class="form-group">
                        <label for="current_username" id="current-username-label">
                            Nykyinen k√§ytt√§j√§nimi
                        </label>
                        <div style="padding: 12px 16px; background: var(--bg-light); border-radius: 10px; border: 2px solid var(--border-light); color: var(--text-dark); font-weight: 500;">
                            {{ user.username }}
                        </div>
                        <small class="helper-text">T√§m√§ on nykyinen k√§ytt√§j√§nimesi</small>
                    </div>

                    <div class="form-group">
                        <label for="new_username" id="new-username-label">
                            Uusi k√§ytt√§j√§nimi <span class="required">*</span>
                        </label>
                        <input type="text"
                               id="new_username"
                               name="new_username"
                               placeholder="uusi_kayttajanimi"
                               required>
                        <small class="helper-text">Sy√∂t√§ uusi k√§ytt√§j√§nimesi</small>
                    </div>

                    <div class="form-group">
                        <label for="confirm_username" id="confirm-username-label">
                            Vahvista uusi k√§ytt√§j√§nimi <span class="required">*</span>
                        </label>
                        <input type="text"
                               id="confirm_username"
                               name="confirm_username"
                               placeholder="uusi_kayttajanimi"
                               required>
                        <small class="helper-text">Sy√∂t√§ uusi k√§ytt√§j√§nimesi uudelleen</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="button-primary" id="update-username-button">
                            ‚úì P√§ivit√§ k√§ytt√§j√§nimi
                        </button>
                    </div>
                </form>
            </div>

            <!-- Password Change Form -->
            <div class="settings-section">
                <h2 id="password-section-title">üîê Vaihda salasana</h2>
                <form action="/update_password" method="post" id="password-form">
                    <div class="form-group">
                        <label for="current_password" id="current-password-label">
                            Nykyinen salasana <span class="required">*</span>
                        </label>
                        <input type="password"
                               id="current_password"
                               name="current_password"
                               required>
                        <small class="helper-text">Sy√∂t√§ nykyinen salasanasi vahvistusta varten</small>
                    </div>

                    <div class="form-group">
                        <label for="new_password" id="new-password-label">
                            Uusi salasana <span class="required">*</span>
                        </label>
                        <input type="password"
                               id="new_password"
                               name="new_password"
                               required
                               minlength="8">
                        <small class="helper-text">Salasanan tulee olla v√§hint√§√§n 8 merkki√§ pitk√§</small>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password" id="confirm-password-label">
                            Vahvista uusi salasana <span class="required">*</span>
                        </label>
                        <input type="password"
                               id="confirm_password"
                               name="confirm_password"
                               required
                               minlength="8">
                        <small class="helper-text">Sy√∂t√§ uusi salasana uudelleen</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="button-primary" id="update-password-button">
                            ‚úì P√§ivit√§ salasana
                        </button>
                    </div>
                </form>
            </div>

            <!-- Back to Home Link -->
            <div class="navigation-links">
                <a href="/" id="back-to-home" class="btn">‚Üê Takaisin etusivulle</a>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}